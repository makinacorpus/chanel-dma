<plominodatabase id="planningdb">
  <design>
    <element id="frmShopProgram" title="Shop program" type="PlominoForm">
      <id type="Products.Archetypes.Field.StringField">frmShopProgram</id>
      <onCreateDocument type="Products.Archetypes.Field.TextField"><![CDATA[]]></onCreateDocument>
      <onOpenDocument type="Products.Archetypes.Field.TextField"><![CDATA[]]></onOpenDocument>
      <beforeSaveDocument type="Products.Archetypes.Field.TextField"><![CDATA[]]></beforeSaveDocument>
      <onSaveDocument type="Products.Archetypes.Field.TextField"><![CDATA[db = context.getParentDatabase()
current_user_id = context.getCurrentUserId()
current_user_roles = context.getCurrentUserRoles()
authors = asList(context.getItem("Plomino_Authors"))
is_locked = context.getItem("planning_locked", False)
authorized = ["[manager]"]

if not is_locked:
   Log("unlocked")
   shop = db.getDocument(context.getItem("shop_id"))
   user_id = str(shop.getItem("shop_manager"))
   for auth in authors:
        if auth not in authorized:
            authorized.append(user_id)

   if not user_id in authorized:
      authorized.append(user_id)
else:
   Log("locked")

context.setItem("Plomino_Authors", authorized)

if "[manager]" in current_user_roles or current_user_id in authorized:
   return plominoDocument.absolute_url() + "/EditDocument"
]]></onSaveDocument>
      <onDeleteDocument type="Products.Archetypes.Field.TextField"><![CDATA[]]></onDeleteDocument>
      <onSearch type="Products.Archetypes.Field.TextField"><![CDATA[]]></onSearch>
      <beforeCreateDocument type="Products.Archetypes.Field.TextField"><![CDATA[]]></beforeCreateDocument>
      <FormLayout type="Products.Archetypes.Field.TextField"><![CDATA[
<p><span class="plominoFieldClass">display_planning</span></p>
<p><span class="plominoFieldClass">planning_data</span></p>
<div class="actions">
<span class="plominoActionClass">save</span><span class="plominoFieldClass">special_request</span> <span class="plominoHidewhenClass">start:isRead</span><span class="plominoFieldClass">submit</span><span class="plominoHidewhenClass">end:isRead</span>
</div>
<div><span class="plominoFieldClass">planning_locked</span></div>
<div>
<p><span class="plominoFieldClass">popup_html</span></p>
</div>
]]></FormLayout>
      <FormMethod type="Products.Archetypes.Field.TextField"><![CDATA[POST]]></FormMethod>
      <DocumentTitle type="Products.Archetypes.Field.TextField"><![CDATA[]]></DocumentTitle>
      <DynamicDocumentTitle type="Products.Archetypes.Field.BooleanField">False</DynamicDocumentTitle>
      <StoreDynamicDocumentTitle type="Products.Archetypes.Field.BooleanField">False</StoreDynamicDocumentTitle>
      <DocumentId type="Products.Archetypes.Field.TextField"><![CDATA[]]></DocumentId>
      <ActionBarPosition type="Products.Archetypes.Field.StringField">BOTTOM</ActionBarPosition>
      <HideDefaultActions type="Products.Archetypes.Field.BooleanField">True</HideDefaultActions>
      <HideInMenu type="Products.Archetypes.Field.BooleanField">False</HideInMenu>
      <isSearchForm type="Products.Archetypes.Field.BooleanField">False</isSearchForm>
      <isPage type="Products.Archetypes.Field.BooleanField">False</isPage>
      <SearchView type="Products.Archetypes.Field.StringField"/>
      <SearchFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></SearchFormula>
      <Position type="Products.Archetypes.Field.IntegerField"/>
      <ResourcesJS type="Products.Archetypes.Field.TextField"><![CDATA[]]></ResourcesJS>
      <ResourcesCSS type="Products.Archetypes.Field.TextField"><![CDATA[]]></ResourcesCSS>
      <excludeFromNav type="Products.Archetypes.Field.BooleanField">False</excludeFromNav>
      <elements>
        <element id="display_planning" title="display_planning" type="PlominoField">
          <id type="Products.Archetypes.Field.StringField">display_planning</id>
          <FieldType type="Products.Archetypes.Field.StringField">RICHTEXT</FieldType>
          <FieldMode type="Products.Archetypes.Field.StringField">DISPLAY</FieldMode>
          <Formula type="Products.Archetypes.Field.TextField"><![CDATA[db = context.getParentDatabase()

library = context.getParentNode().posformats

def getPreviewUrl(path):
    preview = library.getFolderContents(contentFilter= {
                     'path': {
                             'query': path,
                             'depth': -1,
                             'Title': '16/9'
                      },
                      'Type': 'Video file',})
    if preview:
        return preview[0].getObject().absolute_url() + "/at_download/file"
    else:
        return ""


shop = db.getDocument(context.getItem('shop_id'))
program = db.getDocument(context.getItem('program_id'))
all_movies = program.getItem("program_movies")

planning_data = context.getItem("planning_data")
planning_data = (planning_data) and json_loads(planning_data) or {}

movie_css_dict = {"Y": "yes", "N": "no", "X": ""}

year = program.getItem("program_year")
month = program.getItem("program_month")

start_date_str = "%d-%02d-01" % (year, month) 
next_month = StringToDate(start_date_str, "%Y-%m-%d") + 31
next_month_date_str = "%d-%02d-01" % (next_month.year(), next_month.month())
end_date_str = DateToString(StringToDate(next_month_date_str, "%Y-%m-%d") - 1, "%Y-%m-%d")

movies_by_format = {}

def html_information(information, id):
    if information:
        return """<i rel="#info-%s" class="glyphicon glyphicon-info-sign"></i><div class="tooltip" id="info-%s">%s<div class="arrow"></div></div>""" % (id, id, information)
    return ""

for movie in all_movies:
    movie_doc = db.getDocument(movie[0])
    formats = movie_doc.getItem('movie_formats')
    axes = asList(movie_doc.getItem('movie_axes'))
    title = movie_doc.getItem('movie_title')
    movie_path = asList(movie_doc.getItem('movie_link'))
    movie_preview = getPreviewUrl(movie_path)
    for f in formats:
        movies = movies_by_format.setdefault(f, [])
        movies.append({
            'id': movie[0],
            'title': title,
            'information': movie[1],
            'axes': axes,
            'preview': movie_preview
        })
        movies_by_format[f] = movies

Log(movies_by_format)

displays = [a for a in [db.getDocument(id) for id in asList(shop.getItem("shop_displays"))] if a]

planning_locked = context.getItem("planning_locked", False)
lock_html = planning_locked and "<i class='glyphicon glyphicon-lock' style='padding:5px;font-size:60%;'></i>" or ""

html = u"""
<h2 class="planning-shop">%s%s</h2><h3 class="planning-program">%s Programmation</h3><div class="planning-table">
  <div class="display-row">
""" % (shop.getItem('shop_name'), lock_html, program.getItem('program_name'))

for display in displays:
    html += """
    <div class="display-cell"><span>%s</span></div>""" % (display.getItem('display_name'))

html += """
  </div>
  <div class="movies-row">"""

for display in displays:
    display_data = planning_data.get(display.id, {})
    display_axes = asList(display.getItem("display_axes"))

    html += """
    <div class="movies-column" rel="%s">""" % display.id
    for movie in movies_by_format.get(display.getItem('display_formats'), []):
        is_concerned =  [m for m in movie["axes"] if m in display_axes]
        if is_concerned:
            movie_data = display_data.get(movie["id"], {})
            movie_data_status = movie_data.get("status","X")
            movie_data_disabled = (movie_data_status == "Y") and " " or "disabled"
            for status in ("Y","N","X"):
                movie_data["is_%s" % status] = (status == movie_data_status) and "checked" or ""
            html += """
          <div class="movie-cell %(class_css)s" rel="%(id)s">
            <div class="title"><span rel="div.overlay" data-url="%(url)s">%(title)s</span>%(information)s</div>
            <div class="actions">
              <input type="radio" name="choice-%(id)s-%(display_id)s" value="Y" %(is_y)s /> Yes
              <input type="radio" name="choice-%(id)s-%(display_id)s" value="N" %(is_n)s /> No
              <input type="radio" name="choice-%(id)s-%(display_id)s" value="X" %(is_x)s /> ?
            </div>
            <div class="dates">
              <div><span>FROM</span><span><input %(disabled)s type="date" min="%(start)s" max="%(end)s" name="start-%(id)s" value="%(date1)s"></span></div>
              <div><span>TO</span><span><input %(disabled)s type="date" min="%(start)s" max="%(end)s" name="end-%(id)s" value="%(date2)s"></span></div>
            </div>
          </div>
    """ % {
        'title': movie['title'],
        'id': movie['id'], 
        'display_id': display.id,
        'start': start_date_str,
        'url': movie['preview'],
        'end': end_date_str,
        'is_y': movie_data.get("is_Y"),
        'is_n': movie_data.get("is_N"),
        'is_x': movie_data.get("is_X"),
        'date1': movie_data.get("start_date", ""),
        'date2': movie_data.get("end_date", ""),
        'class_css': movie_css_dict.get(movie_data_status, ""),
        'disabled': movie_data_disabled,
        'information': html_information(movie["information"],  "%s-%s" % (movie['id'],display.id))
    }

    html += """
    </div>"""
html += """
  </div></div>"""
return html
]]></Formula>
          <FieldReadTemplate type="Products.Archetypes.Field.StringField"/>
          <FieldEditTemplate type="Products.Archetypes.Field.StringField"/>
          <Mandatory type="Products.Archetypes.Field.BooleanField">False</Mandatory>
          <ValidationFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></ValidationFormula>
          <ToBeIndexed type="Products.Archetypes.Field.BooleanField">False</ToBeIndexed>
          <IndexType type="Products.Archetypes.Field.StringField">DEFAULT</IndexType>
          <HTMLAttributesFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></HTMLAttributesFormula>
        </element>
        <element id="program_id" title="program_id" type="PlominoField">
          <id type="Products.Archetypes.Field.StringField">program_id</id>
          <FieldType type="Products.Archetypes.Field.StringField">TEXT</FieldType>
          <FieldMode type="Products.Archetypes.Field.StringField">EDITABLE</FieldMode>
          <Formula type="Products.Archetypes.Field.TextField"><![CDATA[]]></Formula>
          <FieldReadTemplate type="Products.Archetypes.Field.StringField"/>
          <FieldEditTemplate type="Products.Archetypes.Field.StringField"/>
          <Mandatory type="Products.Archetypes.Field.BooleanField">False</Mandatory>
          <ValidationFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></ValidationFormula>
          <ToBeIndexed type="Products.Archetypes.Field.BooleanField">True</ToBeIndexed>
          <IndexType type="Products.Archetypes.Field.StringField">DEFAULT</IndexType>
          <HTMLAttributesFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></HTMLAttributesFormula>
        </element>
        <element id="shop_id" title="shop_id" type="PlominoField">
          <id type="Products.Archetypes.Field.StringField">shop_id</id>
          <FieldType type="Products.Archetypes.Field.StringField">TEXT</FieldType>
          <FieldMode type="Products.Archetypes.Field.StringField">EDITABLE</FieldMode>
          <Formula type="Products.Archetypes.Field.TextField"><![CDATA[]]></Formula>
          <FieldReadTemplate type="Products.Archetypes.Field.StringField"/>
          <FieldEditTemplate type="Products.Archetypes.Field.StringField"/>
          <Mandatory type="Products.Archetypes.Field.BooleanField">False</Mandatory>
          <ValidationFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></ValidationFormula>
          <ToBeIndexed type="Products.Archetypes.Field.BooleanField">True</ToBeIndexed>
          <IndexType type="Products.Archetypes.Field.StringField">DEFAULT</IndexType>
          <HTMLAttributesFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></HTMLAttributesFormula>
        </element>
        <element id="doctype" title="doctype" type="PlominoField">
          <id type="Products.Archetypes.Field.StringField">doctype</id>
          <FieldType type="Products.Archetypes.Field.StringField">TEXT</FieldType>
          <FieldMode type="Products.Archetypes.Field.StringField">CREATION</FieldMode>
          <Formula type="Products.Archetypes.Field.TextField"><![CDATA["shopprogram"]]></Formula>
          <FieldReadTemplate type="Products.Archetypes.Field.StringField"/>
          <FieldEditTemplate type="Products.Archetypes.Field.StringField"/>
          <Mandatory type="Products.Archetypes.Field.BooleanField">False</Mandatory>
          <ValidationFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></ValidationFormula>
          <ToBeIndexed type="Products.Archetypes.Field.BooleanField">True</ToBeIndexed>
          <IndexType type="Products.Archetypes.Field.StringField">DEFAULT</IndexType>
          <HTMLAttributesFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></HTMLAttributesFormula>
        </element>
        <element id="save" title="Save" type="PlominoAction">
          <id type="Products.Archetypes.Field.StringField">save</id>
          <ActionType type="Products.Archetypes.Field.StringField">SAVE</ActionType>
          <ActionDisplay type="Products.Archetypes.Field.StringField">BUTTON</ActionDisplay>
          <Content type="Products.Archetypes.Field.TextField"><![CDATA[]]></Content>
          <Hidewhen type="Products.Archetypes.Field.TextField"><![CDATA[return not plominoDocument.isNewDocument() and not plominoDocument.isEditMode()]]></Hidewhen>
          <InActionBar type="Products.Archetypes.Field.BooleanField">False</InActionBar>
        </element>
        <element id="planning_data" title="planning_data" type="PlominoField">
          <id type="Products.Archetypes.Field.StringField">planning_data</id>
          <FieldType type="Products.Archetypes.Field.StringField">TEXT</FieldType>
          <FieldMode type="Products.Archetypes.Field.StringField">EDITABLE</FieldMode>
          <Formula type="Products.Archetypes.Field.TextField"><![CDATA[]]></Formula>
          <FieldReadTemplate type="Products.Archetypes.Field.StringField"/>
          <FieldEditTemplate type="Products.Archetypes.Field.StringField"/>
          <Mandatory type="Products.Archetypes.Field.BooleanField">False</Mandatory>
          <ValidationFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></ValidationFormula>
          <ToBeIndexed type="Products.Archetypes.Field.BooleanField">False</ToBeIndexed>
          <IndexType type="Products.Archetypes.Field.StringField">DEFAULT</IndexType>
          <HTMLAttributesFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></HTMLAttributesFormula>
          <params>
<param>
<value><struct>
<member>
<name>widget</name>
<value><string>HIDDEN</string></value>
</member>
</struct></value>
</param>
</params>
        </element>
        <element id="back_to_frontoffice" title="Back to frontoffice" type="PlominoAction">
          <id type="Products.Archetypes.Field.StringField">back_to_frontoffice</id>
          <ActionType type="Products.Archetypes.Field.StringField">REDIRECT</ActionType>
          <ActionDisplay type="Products.Archetypes.Field.StringField"/>
          <Content type="Products.Archetypes.Field.TextField"><![CDATA[db = context.getParentDatabase()
form = db.getForm("frontoffice")
return form.absolute_url()]]></Content>
          <Hidewhen type="Products.Archetypes.Field.TextField"><![CDATA[]]></Hidewhen>
          <InActionBar type="Products.Archetypes.Field.BooleanField">False</InActionBar>
        </element>
        <element id="special_request" title="special_request" type="PlominoField">
          <id type="Products.Archetypes.Field.StringField">special_request</id>
          <FieldType type="Products.Archetypes.Field.StringField">RICHTEXT</FieldType>
          <FieldMode type="Products.Archetypes.Field.StringField">DISPLAY</FieldMode>
          <Formula type="Products.Archetypes.Field.TextField"><![CDATA[html= """<p class="popupcontent">
               <a href="sendto_form" class="btn btn-default context" rel="#pb_2" class="link-overlay" style="cursor: pointer;">
                 Special Request
               </a>
          </p>
"""
return html]]></Formula>
          <FieldReadTemplate type="Products.Archetypes.Field.StringField"/>
          <FieldEditTemplate type="Products.Archetypes.Field.StringField"/>
          <Mandatory type="Products.Archetypes.Field.BooleanField">False</Mandatory>
          <ValidationFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></ValidationFormula>
          <ToBeIndexed type="Products.Archetypes.Field.BooleanField">False</ToBeIndexed>
          <IndexType type="Products.Archetypes.Field.StringField">DEFAULT</IndexType>
          <HTMLAttributesFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></HTMLAttributesFormula>
        </element>
        <element id="submit" title="Submit" type="PlominoField">
          <id type="Products.Archetypes.Field.StringField">submit</id>
          <FieldType type="Products.Archetypes.Field.StringField">RICHTEXT</FieldType>
          <FieldMode type="Products.Archetypes.Field.StringField">DISPLAY</FieldMode>
          <Formula type="Products.Archetypes.Field.TextField"><![CDATA[return """
<button id="submit_sp" class="btn">Submit</button>
"""]]></Formula>
          <FieldReadTemplate type="Products.Archetypes.Field.StringField"/>
          <FieldEditTemplate type="Products.Archetypes.Field.StringField"/>
          <Mandatory type="Products.Archetypes.Field.BooleanField">False</Mandatory>
          <ValidationFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></ValidationFormula>
          <ToBeIndexed type="Products.Archetypes.Field.BooleanField">False</ToBeIndexed>
          <IndexType type="Products.Archetypes.Field.StringField">DEFAULT</IndexType>
          <HTMLAttributesFormula type="Products.Archetypes.Field.TextField"><![CDATA[return "style='visibility:hidden'"]]></HTMLAttributesFormula>
        </element>
        <element id="planning_locked" title="planning_locked" type="PlominoField">
          <id type="Products.Archetypes.Field.StringField">planning_locked</id>
          <FieldType type="Products.Archetypes.Field.StringField">TEXT</FieldType>
          <FieldMode type="Products.Archetypes.Field.StringField">EDITABLE</FieldMode>
          <Formula type="Products.Archetypes.Field.TextField"><![CDATA[]]></Formula>
          <FieldReadTemplate type="Products.Archetypes.Field.StringField"/>
          <FieldEditTemplate type="Products.Archetypes.Field.StringField"/>
          <Mandatory type="Products.Archetypes.Field.BooleanField">False</Mandatory>
          <ValidationFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></ValidationFormula>
          <ToBeIndexed type="Products.Archetypes.Field.BooleanField">False</ToBeIndexed>
          <IndexType type="Products.Archetypes.Field.StringField">DEFAULT</IndexType>
          <HTMLAttributesFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></HTMLAttributesFormula>
          <params>
<param>
<value><struct>
<member>
<name>widget</name>
<value><string>HIDDEN</string></value>
</member>
</struct></value>
</param>
</params>
        </element>
        <element id="isRead" title="isRead" type="PlominoHidewhen">
          <id type="Products.Archetypes.Field.StringField">isRead</id>
          <Formula type="Products.Archetypes.Field.TextField"><![CDATA[return not plominoDocument.isNewDocument() and not plominoDocument.isEditMode()]]></Formula>
          <isDynamicHidewhen type="Products.Archetypes.Field.BooleanField">False</isDynamicHidewhen>
        </element>
        <element id="popup_html" title="popup_html" type="PlominoField">
          <id type="Products.Archetypes.Field.StringField">popup_html</id>
          <FieldType type="Products.Archetypes.Field.StringField">RICHTEXT</FieldType>
          <FieldMode type="Products.Archetypes.Field.StringField">DISPLAY</FieldMode>
          <Formula type="Products.Archetypes.Field.TextField"><![CDATA[return """<div class="overlay overlay-contact">
      <div class="close">
           <span><a href="#">Close this box.</a></span>
      </div>
      <a id="player">   </a>
</div>
<script>
    chanel.planning.manage_show_submit();
</script>"""
]]></Formula>
          <FieldReadTemplate type="Products.Archetypes.Field.StringField"/>
          <FieldEditTemplate type="Products.Archetypes.Field.StringField"/>
          <Mandatory type="Products.Archetypes.Field.BooleanField">False</Mandatory>
          <ValidationFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></ValidationFormula>
          <ToBeIndexed type="Products.Archetypes.Field.BooleanField">False</ToBeIndexed>
          <IndexType type="Products.Archetypes.Field.StringField">DEFAULT</IndexType>
          <HTMLAttributesFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></HTMLAttributesFormula>
        </element>
      </elements>
    </element>
  </design>
</plominodatabase>
