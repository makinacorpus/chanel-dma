<plominodatabase id="planningdb">
  <design>
    <element id="frmShopProgram" title="Shop program" type="PlominoForm">
      <id type="Products.Archetypes.Field.StringField">frmShopProgram</id>
      <onCreateDocument type="Products.Archetypes.Field.TextField"><![CDATA[]]></onCreateDocument>
      <onOpenDocument type="Products.Archetypes.Field.TextField"><![CDATA[]]></onOpenDocument>
      <beforeSaveDocument type="Products.Archetypes.Field.TextField"><![CDATA[]]></beforeSaveDocument>
      <onSaveDocument type="Products.Archetypes.Field.TextField"><![CDATA[]]></onSaveDocument>
      <onDeleteDocument type="Products.Archetypes.Field.TextField"><![CDATA[]]></onDeleteDocument>
      <onSearch type="Products.Archetypes.Field.TextField"><![CDATA[]]></onSearch>
      <beforeCreateDocument type="Products.Archetypes.Field.TextField"><![CDATA[]]></beforeCreateDocument>
      <FormLayout type="Products.Archetypes.Field.TextField"><![CDATA[<p><span class="plominoFieldClass">display_planning</span></p>]]></FormLayout>
      <FormMethod type="Products.Archetypes.Field.TextField"><![CDATA[Auto]]></FormMethod>
      <DocumentTitle type="Products.Archetypes.Field.TextField"><![CDATA[]]></DocumentTitle>
      <DynamicDocumentTitle type="Products.Archetypes.Field.BooleanField">False</DynamicDocumentTitle>
      <StoreDynamicDocumentTitle type="Products.Archetypes.Field.BooleanField">False</StoreDynamicDocumentTitle>
      <DocumentId type="Products.Archetypes.Field.TextField"><![CDATA[]]></DocumentId>
      <ActionBarPosition type="Products.Archetypes.Field.StringField">TOP</ActionBarPosition>
      <HideDefaultActions type="Products.Archetypes.Field.BooleanField">False</HideDefaultActions>
      <HideInMenu type="Products.Archetypes.Field.BooleanField">False</HideInMenu>
      <isSearchForm type="Products.Archetypes.Field.BooleanField">False</isSearchForm>
      <isPage type="Products.Archetypes.Field.BooleanField">False</isPage>
      <SearchView type="Products.Archetypes.Field.StringField"/>
      <SearchFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></SearchFormula>
      <Position type="Products.Archetypes.Field.IntegerField"/>
      <ResourcesJS type="Products.Archetypes.Field.TextField"><![CDATA[]]></ResourcesJS>
      <ResourcesCSS type="Products.Archetypes.Field.TextField"><![CDATA[]]></ResourcesCSS>
      <excludeFromNav type="Products.Archetypes.Field.BooleanField">False</excludeFromNav>
      <elements>
        <element id="display_planning" title="display_planning" type="PlominoField">
          <id type="Products.Archetypes.Field.StringField">display_planning</id>
          <FieldType type="Products.Archetypes.Field.StringField">RICHTEXT</FieldType>
          <FieldMode type="Products.Archetypes.Field.StringField">DISPLAY</FieldMode>
          <Formula type="Products.Archetypes.Field.TextField"><![CDATA[db = context.getParentDatabase()
shop = db.getDocument(context.getItem('shop_id'))
program = db.getDocument(context.getItem('program_id'))
all_movies = program.getItem("program_movies")
# TODO: get the actual month from the doc
year = 2014
month = 4
start_date_str = "%d-%02d-01" % (year, month)
next_month = StringToDate(start_date_str, "%Y-%m-%d") + 31
next_month_date_str = "%d-%02d-01" % (next_month.year(), next_month.month())
end_date_str = DateToString(StringToDate(next_month_date_str, "%Y-%m-%d") - 1, "%Y-%m-%d")
movies_by_format = {}
for movie in all_movies:
    movie_doc = db.getDocument(movie[0])
    formats = movie_doc.getItem('movie_formats')
    for f in formats:
        movies = movies_by_format.setdefault(f, [])
        movies.append({
            'id': movie[0],
            'title': movie_doc.getItem('movie_title'),
            'information': movie[1],
        })
        movies_by_format[f] = movies
displays = [db.getDocument(id) for id in asList(shop.getItem("shop_displays"))]
html = u"""
<h2 class="planning-shop">%s</h2>
<h3 class="planning-program">%s Programmation</h3>
<div class="planning-table">
  <div class="display-row">
""" % (shop.getItem('shop_name'), program.getItem('program_name'))
for display in displays:
    html += """
    <div class="display-cell"><span>%s</span></div>""" % (display.getItem('display_name'))
html += """
  </div>
  <div class="movies-row">"""
for display in displays:
    html += """
    <div class="movies-column">"""
    for movie in movies_by_format.get(display.getItem('display_formats'), []):
        html += """
      <div class="movie-cell">
        <div class="title">%(title)s</div>
        <div class="actions">
          <input type="radio" name="choice-%(id)s" value="Y" /> Yes
          <input type="radio" name="choice-%(id)s" value="N" /> No
          <input type="radio" name="choice-%(id)s" value="X" /> ?
        </div>
        <div class="dates">
          <div><span>FROM</span><span><input disabled="disabled" type="date" min="%(start)s" max="%(end)s" name="start-%(id)s"></span></div>
          <div><span>TO</span><span><input disabled="disabled" type="date" min="%(start)s" max="%(end)s" name="end-%(id)s"></span></div>
        </div>
      </div>
""" % {
    'title': movie['title'],
    'id': movie['id'], 
    'start': start_date_str,
    'end': end_date_str,
}
    html += """
    </div>"""
html += """
  </div>
</div>"""
return html]]></Formula>
          <FieldReadTemplate type="Products.Archetypes.Field.StringField"/>
          <FieldEditTemplate type="Products.Archetypes.Field.StringField"/>
          <Mandatory type="Products.Archetypes.Field.BooleanField">False</Mandatory>
          <ValidationFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></ValidationFormula>
          <ToBeIndexed type="Products.Archetypes.Field.BooleanField">False</ToBeIndexed>
          <IndexType type="Products.Archetypes.Field.StringField">DEFAULT</IndexType>
          <HTMLAttributesFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></HTMLAttributesFormula>
        </element>
        <element id="program_id" title="program_id" type="PlominoField">
          <id type="Products.Archetypes.Field.StringField">program_id</id>
          <FieldType type="Products.Archetypes.Field.StringField">TEXT</FieldType>
          <FieldMode type="Products.Archetypes.Field.StringField">EDITABLE</FieldMode>
          <Formula type="Products.Archetypes.Field.TextField"><![CDATA[]]></Formula>
          <FieldReadTemplate type="Products.Archetypes.Field.StringField"/>
          <FieldEditTemplate type="Products.Archetypes.Field.StringField"/>
          <Mandatory type="Products.Archetypes.Field.BooleanField">False</Mandatory>
          <ValidationFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></ValidationFormula>
          <ToBeIndexed type="Products.Archetypes.Field.BooleanField">False</ToBeIndexed>
          <IndexType type="Products.Archetypes.Field.StringField">DEFAULT</IndexType>
          <HTMLAttributesFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></HTMLAttributesFormula>
        </element>
        <element id="shop_id" title="shop_id" type="PlominoField">
          <id type="Products.Archetypes.Field.StringField">shop_id</id>
          <FieldType type="Products.Archetypes.Field.StringField">TEXT</FieldType>
          <FieldMode type="Products.Archetypes.Field.StringField">EDITABLE</FieldMode>
          <Formula type="Products.Archetypes.Field.TextField"><![CDATA[]]></Formula>
          <FieldReadTemplate type="Products.Archetypes.Field.StringField"/>
          <FieldEditTemplate type="Products.Archetypes.Field.StringField"/>
          <Mandatory type="Products.Archetypes.Field.BooleanField">False</Mandatory>
          <ValidationFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></ValidationFormula>
          <ToBeIndexed type="Products.Archetypes.Field.BooleanField">False</ToBeIndexed>
          <IndexType type="Products.Archetypes.Field.StringField">DEFAULT</IndexType>
          <HTMLAttributesFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></HTMLAttributesFormula>
        </element>
        <element id="doctype" title="doctype" type="PlominoField">
          <id type="Products.Archetypes.Field.StringField">doctype</id>
          <FieldType type="Products.Archetypes.Field.StringField">TEXT</FieldType>
          <FieldMode type="Products.Archetypes.Field.StringField">CREATION</FieldMode>
          <Formula type="Products.Archetypes.Field.TextField"><![CDATA["shopprogram"]]></Formula>
          <FieldReadTemplate type="Products.Archetypes.Field.StringField"/>
          <FieldEditTemplate type="Products.Archetypes.Field.StringField"/>
          <Mandatory type="Products.Archetypes.Field.BooleanField">False</Mandatory>
          <ValidationFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></ValidationFormula>
          <ToBeIndexed type="Products.Archetypes.Field.BooleanField">True</ToBeIndexed>
          <IndexType type="Products.Archetypes.Field.StringField">DEFAULT</IndexType>
          <HTMLAttributesFormula type="Products.Archetypes.Field.TextField"><![CDATA[]]></HTMLAttributesFormula>
        </element>
      </elements>
    </element>
  </design>
</plominodatabase>
